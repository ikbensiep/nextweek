<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
<body>
    <h2>Todos this week</h2>
    <ul class="weekdays">
        <li data-day="0" data-dayname="sunday" data-date=""></li>
        <li data-day="1" data-dayname="monday" data-date=""></li>
        <li data-day="2" data-dayname="tuesday" data-date=""></li>
        <li data-day="3" data-dayname="wednesday" data-date=""></li>
        <li data-day="4" data-dayname="thursday" data-date=""></li>
        <li data-day="5" data-dayname="friday" data-date=""></li>
        <li data-day="6" data-dayname="saturday" data-date=""></li>
    </ul>
    <div class="todo-schedule">
        <ul class="todos-today" data-day="">
            <li data-moment="morning"></li>
            <li data-moment="midday"></li>
            <li data-moment="evening"></li>
        </ul>
    </div>

    <form name="addTasks">
        <input type="text" name="task-label" placeholder="task">
        <input type="text" name="task-moment" placeholder="moment">
        <button type="submit">+ add</button>
    </form>

    <script>
        const today = new Date();
        const weekdays  = document.querySelectorAll('.weekdays li');
        let selectedWeekday = 0;
        let selectedMoment;
        let selectedDate;
        const todos = JSON.parse(localStorage.getItem('todos')) || [];

        function selectDay () {
            selectedWeekday = parseInt(this.dataset.day);
            selectedDate = parseInt(this.dataset.date);
            
            weekdays.forEach(weekday => {
                weekday.classList.remove('selected');
            });
            this.classList.add('selected');
            displayTodos();
        }

        function displayTodos () {
            let days = [];
                    
            weekdays.forEach(weekday => {
                let date = parseInt(weekday.dataset.date);
                let todaystodos = todos.filter(todo => (todo.date == date));
                let html = todaystodos.map(todo => `<li data-moment="${todo.moment}">${todo.label}</li>`);
                days.push(`<ul class="${selectedDate == date ? 'selected' : ''}" data-day="${date}">${html.join('')}</ul>`);
            });
            
            document.querySelector('.todo-schedule').innerHTML = days.join('');

        }

        // sets html data-attribute to day's date
        function displayWeek () {
            let todaysDate = today.getDate();
            let weekstartDate = today.getDate() - today.getDay();

            for (var i=0; i<weekdays.length; i++) {
                weekdays[i].dataset.date = weekstartDate + i;
            }
        }

        function saveTask (e) {
            e.preventDefault();
            let label = this.querySelector('input[name=task-label]');
            let selectedMoment = (this.querySelector('input[name=task-moment]')).value;

            let task = {
                'label': label.value,
                'date': selectedDate,
                'moment': selectedMoment ? selectedMoment : 'morning'
            }

            todos.push(task);
            localStorage.setItem('todos', JSON.stringify(todos));
            

            // For animation reasons, in stead of calling
            // displayTodos(); and re-render the entire calendar
            // we're inserting a node here.
            
            var todaystasks = document.querySelector('ul.selected');
            var li = document.createElement('li');
            var t = document.createTextNode(task.label);
            li.dataset.moment = task.moment;
            li.appendChild(t);
            todaystasks.appendChild(li);
            
            console.log(todaystasks.childNodes.length);

        }

        function initialize () {
            weekdays.forEach(weekday => {
                weekday.dataset.day == today.getDay() 
                    ? weekday.setAttribute('class', 'today selected')
                    : '';
                weekday.addEventListener('click', selectDay);
            });
            selectedDate = today.getDate();
            displayWeek();
            displayTodos();
            document.forms.addTasks.addEventListener('submit', saveTask);
        }
        
        initialize();

    </script>
</body>
</html>